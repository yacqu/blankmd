name: Release

on:
    push:
        tags:
            - "v*"
    # Auto-tag when a release PR is merged
    pull_request:
        types: [closed]
        branches: [main]

permissions:
    contents: write

jobs:
    # When a release/* PR is merged, create the tag automatically
    tag:
        if: >
            github.event_name == 'pull_request' &&
            github.event.pull_request.merged == true &&
            startsWith(github.event.pull_request.head.ref, 'release/v')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Extract version tag
              id: version
              run: |
                  BRANCH="${{ github.event.pull_request.head.ref }}"
                  TAG="${BRANCH#release/}"
                  echo "tag=$TAG" >> "$GITHUB_OUTPUT"

            - name: Create and push tag
              run: |
                  git tag "${{ steps.version.outputs.tag }}"
                  git push origin "${{ steps.version.outputs.tag }}"

    release:
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Build
              run: bun run build

            - name: Rename output
              run: mv dist/index.html dist/blankmd.html

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/blankmd.html
                  generate_release_notes: true
                  draft: false
                  prerelease: false
